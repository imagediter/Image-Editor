<script>
/* =======================
   ELEMENT REFERENCES
======================= */
const uploadArea = document.getElementById('uploadArea');
const browseBtn = document.getElementById('browseBtn');
const fileInput = document.getElementById('fileInput');

const qualitySlider = document.getElementById('qualitySlider');
const qualityValue = document.getElementById('qualityValue');
const sizeSlider = document.getElementById('sizeSlider');
const sizeValue = document.getElementById('sizeValue');

const compressAllBtn = document.getElementById('compressAllBtn');
const downloadAllBtn = document.getElementById('downloadAllBtn');
const deleteAllBtn = document.getElementById('deleteAllBtn');

const imageList = document.getElementById('imageList');
const emptyState = document.getElementById('emptyState');

/* =======================
   GLOBAL STATE
======================= */
let images = [];
let nextId = 1;

/* =======================
   HELPERS
======================= */
function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function updateSliders() {
    qualityValue.textContent = qualitySlider.value + '%';
    sizeValue.textContent = sizeSlider.value + ' KB';
}

/* =======================
   EVENTS
======================= */
browseBtn.onclick = () => fileInput.click();
fileInput.onchange = handleFiles;

qualitySlider.oninput = updateSliders;
sizeSlider.oninput = updateSliders;

compressAllBtn.onclick = () => {
    images.filter(i => !i.compressed).forEach(i => compressImage(i.id));
};

downloadAllBtn.onclick = downloadAll;
deleteAllBtn.onclick = deleteAll;

/* Drag & Drop */
['dragover', 'dragleave', 'drop'].forEach(evt => {
    uploadArea.addEventListener(evt, e => e.preventDefault());
});

uploadArea.addEventListener('dragover', () => uploadArea.classList.add('dragover'));
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', e => {
    uploadArea.classList.remove('dragover');
    handleFiles({ target: { files: e.dataTransfer.files } });
});

/* =======================
   FILE HANDLING
======================= */
function handleFiles(e) {
    const files = [...e.target.files].slice(0, 10);

    files.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        if (file.size > 20 * 1024 * 1024) return;

        const reader = new FileReader();
        reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
                images.push({
                    id: nextId++,
                    name: file.name,
                    originalSize: file.size,
                    width: img.width,
                    height: img.height,
                    src: ev.target.result,
                    compressed: false,
                    compressedSrc: null,
                    compressedSize: 0
                });
                render();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    });

    fileInput.value = '';
}

/* =======================
   COMPRESSION
======================= */
function compressImage(id) {
    const image = images.find(i => i.id === id);
    if (!image || image.compressed) return;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const img = new Image();
    img.onload = () => {
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(img, 0, 0);

        const targetBytes = Math.max(sizeSlider.value * 1024, 10 * 1024);
        let quality = qualitySlider.value / 100;
        let output, size;

        for (let i = 0; i < 10; i++) {
            output = canvas.toDataURL('image/jpeg', quality);
            size = Math.round((output.length * 3) / 4);
            if (size <= targetBytes) break;
            quality -= 0.08;
        }

        if (size < 10 * 1024) {
            output = canvas.toDataURL('image/jpeg', 0.3);
            size = Math.round((output.length * 3) / 4);
        }

        image.compressed = true;
        image.compressedSrc = output;
        image.compressedSize = size;

        render();
    };
    img.src = image.src;
}

/* =======================
   DOWNLOADS
======================= */
function downloadOne(image) {
    const a = document.createElement('a');
    a.href = image.compressedSrc;
    a.download = 'compressed_' + image.name;
    a.click();
}

function downloadAll() {
    const list = images.filter(i => i.compressed);
    if (!list.length) return alert('Compress images first');

    list.forEach((img, i) => {
        setTimeout(() => downloadOne(img), i * 300);
    });
}

/* =======================
   DELETE
======================= */
function deleteAll() {
    if (!images.length) return;
    if (!confirm('Delete all images?')) return;
    images = [];
    render();
}

function deleteOne(id) {
    images = images.filter(i => i.id !== id);
    render();
}

/* =======================
   UI RENDER
======================= */
function render() {
    imageList.innerHTML = '';

    if (!images.length) {
        imageList.appendChild(emptyState);
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';

    images.forEach(img => {
        const div = document.createElement('div');
        div.className = 'image-card';

        div.innerHTML = `
            <img src="${img.src}" class="image-preview">
            <div class="image-info">
                <div>${img.name}</div>
                <div>${img.width}×${img.height}</div>
            </div>
            <div class="image-info">
                <div>Original: <span>${formatSize(img.originalSize)}</span></div>
                <div>Compressed: <span>${img.compressed ? formatSize(img.compressedSize) : '—'}</span></div>
            </div>
            <div class="card-actions">
                <button class="card-btn card-compress" ${img.compressed ? 'disabled' : ''}>
                    Compress
                </button>
                <button class="card-btn card-download" ${!img.compressed ? 'disabled' : ''}>
                    Download
                </button>
                <button class="card-btn card-delete">Delete</button>
            </div>
        `;

        div.querySelector('.card-compress').onclick = () => compressImage(img.id);
        div.querySelector('.card-download').onclick = () => downloadOne(img);
        div.querySelector('.card-delete').onclick = () => deleteOne(img.id);

        imageList.appendChild(div);
    });
}

updateSliders();
render();
</script>
