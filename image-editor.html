<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Image Editor | Nano Banana</title>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Konva -->
<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<script src="https://unpkg.com/react-konva@18/react-konva.umd.js"></script>

<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
}
canvas { touch-action:none; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useRef, useEffect, useCallback } = React;
const { Stage, Layer, Image: KonvaImage, Line } = ReactKonva;

/* ---------------- LOADER ---------------- */
const Loader = () => (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div className="bg-white px-6 py-5 rounded-xl shadow-xl text-center">
      <div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
      <p className="mt-3 font-medium text-gray-700">AI Processing...</p>
    </div>
  </div>
);

/* ---------------- UPLOADER ---------------- */
function ImageUploader({ onUpload }) {
  return (
    <div className="bg-white rounded-xl p-8 text-center shadow-xl cursor-pointer"
      onClick={() => document.getElementById("file").click()}>
      <p className="text-lg font-semibold text-gray-700">Click or Drop Image</p>
      <p className="text-sm text-gray-500 mt-1">JPG, PNG, WebP</p>
      <input hidden id="file" type="file" accept="image/*"
        onChange={e => e.target.files[0] && onUpload(e.target.files[0])} />
    </div>
  );
}

/* ---------------- EDITOR ---------------- */
function Editor({ image, tool, onMask }) {
  const stageRef = useRef();
  const [points, setPoints] = useState([]);
  const [drawing, setDrawing] = useState(false);

  const width = Math.min(window.innerWidth - 40, 800);
  const height = width * (image.height / image.width);

  useEffect(() => {
    if (!points.length) return;

    const c = document.createElement("canvas");
    c.width = image.width;
    c.height = image.height;
    const ctx = c.getContext("2d");

    ctx.fillStyle = "black";
    ctx.fillRect(0,0,c.width,c.height);
    ctx.strokeStyle = "white";
    ctx.lineWidth = 20;
    ctx.lineCap = "round";

    ctx.beginPath();
    ctx.moveTo(points[0], points[1]);
    for (let i=2;i<points.length;i+=2) {
      ctx.lineTo(points[i], points[i+1]);
    }
    ctx.stroke();

    onMask(c.toDataURL());
  }, [points]);

  return (
    <Stage
      ref={stageRef}
      width={width}
      height={height}
      onMouseDown={e=>{
        const p = e.target.getStage().getPointerPosition();
        setDrawing(true);
        setPoints([p.x, p.y]);
      }}
      onMouseMove={e=>{
        if(!drawing) return;
        const p = e.target.getStage().getPointerPosition();
        setPoints(prev=>[...prev,p.x,p.y]);
      }}
      onMouseUp={()=>setDrawing(false)}
      className="mx-auto bg-gray-100 rounded-xl"
    >
      <Layer>
        <KonvaImage image={image} width={width} height={height}/>
        <Line points={points} stroke="red" strokeWidth={20} />
      </Layer>
    </Stage>
  );
}

/* ---------------- MOCK AI ---------------- */
const fakeAI = (file) =>
  new Promise(res=>{
    setTimeout(()=>{
      const img = new Image();
      img.onload=()=>{
        const c=document.createElement("canvas");
        c.width=img.width;c.height=img.height;
        const ctx=c.getContext("2d");
        ctx.filter="grayscale(1)";
        ctx.drawImage(img,0,0);
        res(c.toDataURL());
      };
      img.src=URL.createObjectURL(file);
    },2000);
  });

/* ---------------- APP ---------------- */
function App(){
  const [img,setImg]=useState(null);
  const [file,setFile]=useState(null);
  const [edited,setEdited]=useState(null);
  const [loading,setLoading]=useState(false);
  const [mask,setMask]=useState(null);

  const upload=f=>{
    const i=new Image();
    i.onload=()=>setImg(i);
    i.src=URL.createObjectURL(f);
    setFile(f);
  };

  const generate=async()=>{
    if(!file||!mask) return alert("Select area first");
    setLoading(true);
    const out=await fakeAI(file);
    setEdited(out);
    setLoading(false);
  };

  return(
    <div className="p-4 max-w-6xl mx-auto">
      {loading && <Loader/>}

      <h1 className="text-3xl font-bold text-white text-center mb-6">
        AI Image Editor
      </h1>

      {!img ? (
        <ImageUploader onUpload={upload}/>
      ) : (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div className="lg:col-span-2 bg-white p-4 rounded-xl shadow-xl">
            <Editor image={img} tool="brush" onMask={setMask}/>
            <button onClick={generate}
              className="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
              Generate AI Edit
            </button>
          </div>

          <div className="bg-white p-4 rounded-xl shadow-xl">
            <h3 className="font-semibold mb-2">Result</h3>
            {edited
              ? <img src={edited} className="w-full rounded"/>
              : <p className="text-sm text-gray-500">No output yet</p>}
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById("root"));
</script>
</body>
</html>
