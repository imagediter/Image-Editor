const fileInput = document.getElementById('file-input');
const imageList = document.getElementById('image-list');
const bulkActions = document.getElementById('bulk-actions');

fileInput.addEventListener('change', handleFiles);

function handleFiles(e) {
    const files = Array.from(e.target.files);
    if (files.length > 0) bulkActions.style.display = 'block';
    
    files.forEach(file => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            createImageCard(event.target.result, file.name);
        };
    });
}

function createImageCard(src, fileName) {
    const card = document.createElement('div');
    card.className = 'image-card';
    
    card.innerHTML = `
        <img src="${src}" class="preview-img">
        <div class="controls-row">
            <small>${fileName}</small>
            <label>Quality: <span class="q-val">80</span>%</label>
            <input type="range" class="quality-slider" min="1" max="100" value="80">
            <button class="btn download-btn">Download Compressed</button>
        </div>
    `;

    const slider = card.querySelector('.quality-slider');
    const qValDisplay = card.querySelector('.q-val');
    const downloadBtn = card.querySelector('.download-btn');

    slider.oninput = () => qValDisplay.innerText = slider.value;

    downloadBtn.onclick = () => {
        compressAndDownload(src, fileName, slider.value / 100);
    };

    imageList.appendChild(card);
}

function compressAndDownload(src, fileName, quality) {
    const img = new Image();
    img.src = src;
    img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        // Convert to blob
        canvas.toBlob((blob) => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `compressed_${fileName}`;
            link.click();
        }, 'image/jpeg', quality);
    };
}

function clearAll() {
    imageList.innerHTML = '';
    bulkActions.style.display = 'none';
    fileInput.value = '';
}
